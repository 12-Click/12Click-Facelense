<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jovenes Misioneros!</title>
    <link rel="shortcut icon" href="images/logo2.png">
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background: black;
            touch-action: none;
        }

        .container {
            position: relative;
            width: 100vw;
            height: 100vh;
            touch-action: none;
        }

        video {
            width: 100vw;
            height: 100vh;
            object-fit: cover;
            transform: scaleX(-1);
            display: block;
        }

        .overlay {
            position: absolute;
            pointer-events: none;
            display: none;
        }

        #halo, #text {
            width: 50%;
            left: 50%;
            transform: translate(-50%, 0);
        }

        .capture-button {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 6px 12px;
            background-color: #87CEEB;
            color: white;
            font-size: 14px;
            font-weight: bold;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            z-index: 10;
            transition: all 0.3s ease;
            display: none;
        }

        .capture-button:hover {
            background-color: #6db0d5;
        }

        .capture-button:active {
            transform: scale(0.97);
        }

        #polaroidDisplay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: none;
            z-index: 20;
        }

        #successMessage {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            font-size: 16px;
            display: none;
        }

        /* Flash effect */
        .flash {
            position: absolute;
            width: 100%;
            height: 100%;
            background: white;
            opacity: 0.6;
            pointer-events: none;
            display: none; /* Initially hide */
            z-index: 30;
        }
    </style>
</head>
<body>
    <div class="container" id="screenshot-container">
        <video id="video" playsinline autoplay muted></video>
        <img id="halo" class="overlay" src="images/200.gif" alt="Halo">
        <img id="text" class="overlay" src="images/IMG_3383.gif" alt="Text">
        
        <button id="captureButton" class="capture-button" onclick="captureSelfie()">Selfie</button>

        <!-- Flash Effect -->
        <div id="flashEffect" class="flash"></div>

        <!-- Polaroid Display -->
        <img id="polaroidDisplay" alt="Polaroid" />
        <div id="successMessage">Photo saved successfully!</div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh"></script>
    <script>
        const video = document.getElementById('video');
        const halo = document.getElementById('halo');
        const text = document.getElementById('text');
        const captureButton = document.getElementById('captureButton');
        const polaroidDisplay = document.getElementById('polaroidDisplay');
        const successMessage = document.getElementById('successMessage');
        const flashEffect = document.getElementById('flashEffect');

        const faceMesh = new FaceMesh({
            locateFile: (file) => {
                return `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`;
            }
        });

        faceMesh.onResults(onResults);

        const camera = new Camera(video, {
            onFrame: async () => {
                await faceMesh.send({ image: video });
            },
            width: 640,
            height: 480
        });
        camera.start();

        function onResults(results) {
            if (results.multiFaceLandmarks && results.multiFaceLandmarks.length > 0) {
                const landmarks = results.multiFaceLandmarks[0];

                halo.style.display = 'block';
                text.style.display = 'block';

                const forehead = landmarks[10];
                halo.style.left = `${(1 - forehead.x) * video.clientWidth}px`;
                halo.style.top = `${forehead.y * video.clientHeight - 200}px`;

                const chin = landmarks[152];
                text.style.left = `${(1 - chin.x) * video.clientWidth}px`;
                text.style.top = `${chin.y * video.clientHeight + 20}px`;
            } else {
                halo.style.display = 'none';
                text.style.display = 'none';
            }
        }

        function captureSelfie() {
            captureButton.style.display = 'none';

            const container = document.getElementById('screenshot-container');

            html2canvas(container, {
                width: container.clientWidth,
                height: container.clientHeight,
                scale: 3,
                useCORS: true
            }).then(canvas => {
                const image = canvas.toDataURL('image/png');

                const polaroidCanvas = document.createElement('canvas');
                const ctx = polaroidCanvas.getContext('2d');

                const mobileAspectRatio = 9 / 16;
                const polaroidWidth = Math.min(window.innerWidth * 0.9, 300);
                const polaroidHeight = polaroidWidth / mobileAspectRatio;

                polaroidCanvas.width = polaroidWidth;
                polaroidCanvas.height = polaroidHeight;

                const img = new Image();
                img.onload = function() {
                    ctx.fillStyle = "white";
                    ctx.fillRect(0, 0, polaroidWidth, polaroidHeight);
                    ctx.fillRect(0, 0, polaroidWidth, 20);

                    const imgWidth = polaroidWidth - 40;
                    const imgHeight = imgWidth / mobileAspectRatio;
                    const offsetX = 20;
                    const offsetY = 20;

                    ctx.drawImage(img, offsetX, offsetY, imgWidth, imgHeight);

                    ctx.fillStyle = "white";
                    ctx.fillRect(0, 0, 30, polaroidHeight);
                    ctx.fillRect(polaroidWidth - 30, 0, 30, polaroidHeight);

                    const polaroidImage = polaroidCanvas.toDataURL('image/png');

                    polaroidDisplay.src = polaroidImage;
                    polaroidDisplay.style.display = 'block';

                    successMessage.style.display = 'block';

                    setTimeout(() => {
                        polaroidDisplay.style.display = 'none';
                        successMessage.style.display = 'none';
                    }, 3000);

                    const link = document.createElement('a');
                    link.href = polaroidImage;
                    link.download = 'selfie_polaroid.png';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                };
                img.src = image;
            });

            // Flash effect
            flashEffect.style.display = 'block';
            setTimeout(() => {
                flashEffect.style.display = 'none';
            }, 200); // Flash lasts for 200 milliseconds

            captureButton.style.display = 'block';
        }

        video.addEventListener('loadedmetadata', () => {
            captureButton.style.display = 'block';
        });
    </script>
</body>
</html>